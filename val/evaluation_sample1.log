Using device: cuda
Loading checkpoint from: ../repairing/near_repairing/checkpoints/Coronary_class9_shape_only_251108_183434/best.pth
Model loaded successfully!

Loading original segmentation from: ../../dataset/near_format_data/shape/1.npy
Original shape: (256, 256, 256), unique classes: [ 0  1  2  3  4  5  6  7  8  9 10]
Coronary voxels in original: 23969
Running inference for sample 0 at resolution 256³...
Inference complete. Positive voxels: 3376050
Coronary voxels in refined: 3376050

======================================================================
Connected Components Analysis
======================================================================

Original Segmentation:
  Number of CCs: 2
  Largest CC size: 13943 voxels
  Top 5 CC sizes: [np.int64(13943), np.int64(10026)]

Refined Segmentation:
  Number of CCs: 2
  Largest CC size: 3058076 voxels
  Top 5 CC sizes: [np.int64(3058076), np.int64(317974)]

Change:
  CC reduction: 0 (2 → 2)

======================================================================
Volumetric Dice Coefficient: 0.0019
======================================================================

======================================================================
Surface Dice Analysis (Better for boundary quality)
======================================================================

Voxel spacing: (1.0, 1.0, 1.0) mm

Surface Dice at different tolerances:
  Tolerance 0.5mm: Surface Dice = 0.0089
  Tolerance 1.0mm: Surface Dice = 0.0195
  Tolerance 2.0mm: Surface Dice = 0.0324
  Tolerance 3.0mm: Surface Dice = 0.0505

Average Surface Distances (at 1mm tolerance):
  Original → Refined: 4.988 mm
  Refined → Original: 46.488 mm
  Mean: 25.738 mm

Interpretation:
  ✗ Poor boundary quality (Surface Dice < 0.70)
  ✗ Poor surface alignment (avg dist > 2.0mm)
======================================================================
======================================================================

======================================================================
Voxel Occupancy Analysis
======================================================================
Total voxels: 16,777,216

Original Segmentation:
  Positive voxels: 23,969
  Occupancy ratio: 0.1429%

Refined Segmentation:
  Positive voxels: 3,376,050
  Occupancy ratio: 20.1228%

Change:
  Absolute change: +3,352,081 voxels
  Ratio change: +19.9800%
  Relative change: +13985.07%

⚠️  Warning: Volume changed by more than 20%! Check refinement quality.
======================================================================

Generating visualization...
Warning: CT image not found at ../../../dataset/near_format_data/images_256/1.npy, using segmentation only
Visualization saved to: ./evaluation_results_coronary/sample_1_comparison.png
Refined mask saved to: ./evaluation_results_coronary/sample_1_refined.npy
Summary saved to: ./evaluation_results_coronary/sample_1_summary.txt

Evaluation complete!
